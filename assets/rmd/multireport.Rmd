---
title: "Report"
author: "`r Sys.getenv('USER')`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    flexdashboard::flex_dashboard:
        orientation: rows
params:
    indir: "../../results/samples"
---

```{r setup}
knitr::opts_chunk$set(echo = FALSE)
```


```{r include=FALSE}
library(tidyverse)
library(gt)
library(flexdashboard)
source("lib_typing.R")
```


```{r include=FALSE}
db <- db_load(params$indir)
assemblies <- summarise_assembly(db)
contigs <- summarise_contigs(db) |>
	mutate(is_plasmid = (contig_length<=500000) & lengths(plasmid_types)>0)
```


# Species

Row
-------------------------

### Assemblies
```{r}
valueBox(nrow(assemblies),"Samples")
```

### Contigs
```{r}
valueBox(nrow(contigs),"Contigs")
```

### Plasmids
```{r}
valueBox(sum(contigs$is_plasmid),"Plasmids")
```

Row
-------------------------


### Samples Identity: Species/ST
```{r}
bind_rows(
		assemblies |> 
			group_by(
				id=str_c("lev1",genus_name,sep="-"),
				label=genus_name,
				parent=""
			) |> count(),
		assemblies |> 
			group_by(
				id = str_c("lev2",genus_name,species_name,sep="-"),
				label = species_name,
				parent = str_c("lev1",genus_name,sep="-")
			) |> count(),
		assemblies |> 
			group_by(
				id = str_c("lev3",genus_name,species_name,mlst_type,sep="-"),
				label = mlst_type,
				parent = str_c("lev2",genus_name,species_name,sep="-")
			) |> count()
) |>
plotly::plot_ly(
		ids = ~id,
		labels = ~label,
	  parents = ~parent,
	  values = ~n,
	  type = 'sunburst',
	  branchvalues = 'total'
) %>%
plotly::config(displayModeBar=FALSE)
```


### Resistances


# Assemblies
```{r}
assemblies |>
	select(mlst_type,assembly_id,num_contig,assembly_length,GC,species_name,orgfinder.species_name,orgfinder.ani) |>
	mutate(GC=100*GC) |>
	group_by(species_name) |>
	gt::gt(row_group_as_column=TRUE,caption = "Assemblies overview") |>
	gt::tab_stubhead("Species Name")  |>
	gt::tab_style(list(gt::cell_text(weight="bold"),gt::cell_fill()),locations=gt::cells_column_labels()) |>
	gt::tab_style(list(gt::cell_text(weight="bold"),gt::cell_fill()),locations=gt::cells_stubhead()) |>		
	gt::fmt_number(c(assembly_length),decimals = 0,pattern="{x} bp") |>
	gt::fmt_number(c(orgfinder.ani,GC),decimals = 1,pattern="{x}%") |>
	gt::tab_style(list(gt::cell_fill(color = "tomato")),locations=gt::cells_body(orgfinder.ani,rows = orgfinder.ani<=97)) |>
	gt::tab_style(list(gt::cell_fill(color = "tomato")),locations=gt::cells_body(orgfinder.species_name,rows = orgfinder.species_name!=species_name))
```




# Assembly QC {.tabset}

### Overview

```{r}
plotly::plot_ly(
	data = assemblies,
	x = ~num_contig,
	y = ~assembly_length,
	text = ~str_glue('
		{assembly_id}
		{sprintf("%s (%.1f%%)",orgfinder.species_name,orgfinder.ani)}
		ST: {mlst_type}
		GC: {sprintf("%.1f%%",100*GC)}
	')
) %>%
plotly::config(displayModeBar=FALSE)
```


### Detail
```{r}
contigs |>
	left_join(select(assemblies,assembly_id,species_name,genus_name),by="assembly_id") |>
  mutate(assembly_id = fct_reorder(assembly_id,contig_length,sum)) |>
  mutate(contig_id = fct_reorder(contig_id,contig_length,sum)) |>
  ggplot() + 
      facet_grid(genus_name~.,space = "free_y",scales="free_y") +
      geom_col(aes(x=contig_length,y=assembly_id,group=contig_id,fill=is_plasmid),color="black",position="stack") + 
      scale_x_continuous(position="top",labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
      theme_bw() + theme(legend.position="top") +
			theme(strip.text.y = element_text(angle=0))
```




