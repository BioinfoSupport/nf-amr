---
title: "QC"
author: "`r Sys.getenv('USER')`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_download: true
    code_folding: hide
    toc: true
    toc_float: true
    fig_caption: true
params:
    outdir: "out/qc_oxa48_r88"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE)
library(tidyverse)
library(BiocParallel)
BiocParallel::register(BiocParallel::MulticoreParam(workers=6,progress=TRUE))
```

```{r include=FALSE}
source("lib_typing.R")
```



# Load sample-sheet associated data {.tabset}

- Load samplesheet

```{r include=FALSE}
# Load the sample sheet
ss <- openxlsx::read.xlsx("data/sample_sheet_oxa48.xlsx","barcodes") |>
 	mutate(assembly_id = str_glue("r{run_id}b{bc}")) |>
	#filter(!(is.na(exclusion_comment) | str_detect(exclusion_comment,"^ *$")))
	filter(is.na(exclusion_comment) | str_detect(exclusion_comment,"^ *$"))
	#filter(assembly_id %in% c("r11b22","r2b3","r14b21"))
db <- db_load(ss,"out/data_OXA48")

# ss <- tibble(
# 	assembly_id = c("VS32.r11.hyb","VS.r14.hyb")
# )
# db <- db_load(ss,"data/VS32_test_asm")

# ss <- openxlsx::read.xlsx("data/sample_sheet_CFRE_MAY.xlsx","barcodes") |>
#   mutate(assembly_id = str_glue("r{run_id}b{bc}"))
# db <- db_load(ss,"out/data_CFRE")
```


- Filter samples to keep only OXA-48 detected strains

```{r}
oxa48_contigs <- db$resfinder |> subset(resistance_name %in% "blaOXA-48") |> seqnames()
oxa48_assemblies <- filter(db$contigs,contig_id %in% oxa48_contigs) |> distinct(assembly_id) |> pull()
ss <- filter(ss,assembly_id %in% oxa48_assemblies)
db$contigs <- filter(db$contigs,assembly_id %in% oxa48_assemblies)
db$species <- filter(db$species,assembly_id %in% oxa48_assemblies)
db$resfinder <- keepSeqlevels(db$resfinder,intersect(seqlevels(db$resfinder),db$contigs$contig_id),pruning.mode = "coarse")
db$plasmidfinder <- keepSeqlevels(db$plasmidfinder,intersect(seqlevels(db$plasmidfinder),db$contigs$contig_id),pruning.mode = "coarse")
db$mlst <- filter(db$mlst,assembly_id %in% oxa48_assemblies)
```

- Assign best species hit to each assembly and improve annotation

```{r}
db$species <- db$species |>
	left_join(read_tsv("local/species_profiler/notebooks/db_tax.tsv") |> select(assembly_acc,species_name,genus_name),by="assembly_acc") |>
	mutate(species_name=factor(species_name),genus_name=factor(genus_name))
db$SPECIES <- db$species |>
	group_by(assembly_id) |>
	slice_max(ANI,n=1) |>
	right_join(select(ss,assembly_id))
```




## Summary
```{r,message=TRUE}
message(str_glue("Number of sample/assembly: {nrow(ss)}"))
message(str_glue("Number of contig: {nrow(db$contigs)}"))
```





```{r io, echo=FALSE}
dir.create(fs::path(params$outdir))
saveRDS(ss,fs::path(params$outdir,"ss.rds"))
saveRDS(db,fs::path(params$outdir,"db.rds"))

# Aggregate DB in summary tables
local({
	aggr_samples <- select(ss,-assembly_name,-other_assembly_name) |>
		left_join(by="assembly_id",relationship = "one-to-one",db$contigs |>
			group_by(assembly_id) |>
			summarise(num_contig=n(),total_assembly_length=sum(contig_length))
		) |>
		left_join(by="assembly_id",relationship = "one-to-one",select(db$SPECIES,assembly_id,org_name,tax_id,org_ANI=ANI,species_name,genus_name)) |>
		left_join(by="assembly_id",relationship = "one-to-one",db$mlst)
	
	aggr_contigs <- db$contigs |>
		left_join(by="assembly_id",relationship = "many-to-one",aggr_samples) |> # Add samples data
		left_join(by="contig_id",# Add plasmid types
			as.data.frame(db$plasmidfinder) |> 
			distinct(contig_id=seqnames,plasmid_type) |>
			group_by(contig_id) |>
			summarize(plasmidfinder_types = list(plasmid_type))
		) |>
		left_join(by="contig_id",
			as.data.frame(db$resfinder) |> 
			distinct(contig_id=seqnames,resistance_name) |>
			group_by(contig_id) |>
			summarize(resistances = list(resistance_name))
		) |>
		mutate(is_plasmid = lengths(plasmidfinder_types)>0 & (contig_length<=500000))
	
	aggr_samples_with_res <- aggr_samples |>
		left_join(by="assembly_id",relationship = "one-to-one",
			select(aggr_contigs,assembly_id,resistances) |>
				unnest(resistances) |>
				distinct(assembly_id,resistances) |>
				group_by(assembly_id) |>
				summarise(resistances=list(resistances))
		)
	
	# expand resistance columns
	aggr_samples_with_res <- left_join(by="assembly_id",
		aggr_samples_with_res,
		aggr_samples_with_res |>
			select(assembly_id,resistances) |>
			unnest(resistances) |>
			mutate(value="y") |>
			pivot_wider(id_cols = assembly_id,names_from = resistances,names_prefix = "res_")
	) |>
		mutate(resistances = unstrsplit(resistances,sep=" /// "))
		
	
	# Expand resistance and plasmidfinder columns
	aggr_contigs <- aggr_contigs |>
		left_join(by="contig_id",
			aggr_contigs |>
				select(contig_id,resistances) |>
				unnest(resistances) |>
				mutate(value="y") |>
				pivot_wider(id_cols = contig_id,names_from = resistances,names_prefix = "res_")
		) |>
		mutate(resistances = unstrsplit(resistances,sep=" /// ")) |>
		left_join(by="contig_id",
			aggr_contigs |>
				select(contig_id,plasmidfinder_types) |>
				unnest(plasmidfinder_types) |>
				mutate(value="y") |>
				pivot_wider(id_cols = contig_id,names_from = plasmidfinder_types,names_prefix = "plf_")
		) |>
		mutate(plasmidfinder_types = unstrsplit(plasmidfinder_types,sep=" /// "))
	openxlsx::write.xlsx(
		list(samples = aggr_samples_with_res,contigs = aggr_contigs),
		fs::path(params$outdir,"aggregated_results.xlsx")
	)
})
xfun::embed_file(fs::path(params$outdir,"aggregated_results.xlsx"),text="Download aggregated results in XLSX format")
```




# Detected Species {.tabset}

## Overview


```{r fig.height=5, fig.width=9}
db$SPECIES |>
	ggplot(aes(y=org_name,fill=ANI>95)) + 
		geom_bar(color="black") +
		geom_text(aes(label=after_stat(count)),stat = "count",position=position_stack(vjust=0.5),size=3) + 
		facet_grid(genus_name~.,space="free",scales = "free") + 
		theme_bw() +
		theme(
			panel.spacing = unit(0,"mm"),
			panel.grid = element_blank(),
			strip.text.y = element_text(angle = 0),
			axis.text.x = element_text(angle=30,hjust=1,vjust=1),
			legend.position = "top",strip.placement = "outside"
		)
```
```{r fig.height=7, fig.width=7}
db$SPECIES |>
	left_join(ss,by="assembly_id") |>
	group_by(org_name,hug_species) |>
	summarise(n=n()) |>
	ggplot(aes(org_name,hug_species,fill=n)) + 
		geom_tile() + 
		geom_text(aes(label=n),size=3) + 
		coord_equal() +
		scale_fill_gradient(low=scales::muted("red"),high="yellow") +
		theme(axis.text.x=element_text(angle=30,hjust = 1,vjust=1))
```


## Roberto reordered
```{r fig.height=3, fig.width=8,eval=FALSE}
db$SPECIES |>
	mutate(org_name = fct_recode(org_name,"Citrobacter murliniae"="Citrobacter tructae")) |>
	mutate(complex = fct_collapse(
		org_name,
		"Citrobacter complex" = c("Citrobacter freundii","Citrobacter werkmanii","Citrobacter braakii","Citrobacter portucalensis","Citrobacter murliniae"),
		other_level = "Other Citrobacter"
	)) |>
	filter(genus_name %in% "Citrobacter") |>
	group_by(complex) |>
	mutate(org_name=fct_reorder(org_name,rep(1,n()),sum,.desc=FALSE)) |>
	ggplot(aes(y=org_name,fill=ANI>95)) + 
		geom_bar(color="black") +
		geom_text(aes(label=after_stat(count)),stat = "count",position=position_stack(vjust=0.5),size=3) + 
		facet_grid(complex~.,space="free",scales = "free") + 
		scale_x_continuous(position="top") +
		theme_bw() +
		theme(
			panel.spacing = unit(0,"mm"),
			panel.grid = element_blank(),
			strip.text.y = element_text(angle = 0),
			legend.position = "bottom",strip.placement = "outside"
		) + ylab("") + xlab("Number of sample")
```

## Top ANI
```{r}
db$SPECIES |>
	select(assembly_id,genus_name,org_name,ANI) |>
	knitr::kable()
```

## Reduced ANI Heatmap
```{r fig.height=4, fig.width=13}
db$species |>
	group_by(assembly_id) |>
	mutate(org = pull(slice_max(pick(ANI,org_name),ANI,n=1))) |>
	ungroup() |>
	mutate(assembly_id=fct_reorder(assembly_id,org,min)) |>
	filter(org_name %in% org) |>
	ggplot() + 
		geom_tile(aes(x=assembly_id,y=org_name,fill=ANI)) + 
		facet_grid(genus_name~.,space="free",scales = "free") + 
		theme_bw() +
		theme(
			panel.spacing = unit(0,"mm"),
			panel.grid = element_blank(),
			strip.text.y = element_text(angle = 0),
			axis.text.x = element_text(angle=30,hjust=1,vjust=1),
			legend.position = "top"
		)
```

## Full ANI Heatmap
```{r fig.height=20, fig.width=13}
db$species |>
	group_by(assembly_id) |>
	mutate(org = pull(slice_max(pick(ANI,org_name),ANI,n=1))) |>
	ungroup() |>
	mutate(assembly_id=fct_reorder(assembly_id,org,min)) |>
	ggplot() + 
		geom_tile(aes(x=assembly_id,y=org_name,fill=ANI)) + 
		facet_grid(genus_name~.,space="free",scales = "free") + 
		theme_bw() +
		theme(
			panel.spacing = unit(0,"mm"),
			panel.grid = element_blank(),
			strip.text.y = element_text(angle = 0),
			axis.text.x = element_text(angle=30,hjust=1,vjust=1),
			legend.position = "top"
		)
```





# Assembly statistics {.tabset}

## Overview
```{r fig.height=3, fig.width=3}
db$contigs |>
	group_by(assembly_id) |>
	summarize(num_contig = n(),assembly_len=sum(contig_length)) |>
	left_join(db$SPECIES,by="assembly_id") |>
	ggplot(aes(x=num_contig,y=assembly_len)) + 
		geom_point(aes(color=genus_name)) + 
		ggrepel::geom_text_repel(aes(label=assembly_id),size=2) + 
	  scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
		theme_bw() + scale_x_log10() + theme(legend.position = "none")
```


## Detailed {.tabset}

### Color by topology
```{r fig.height=18, fig.width=7}
db$contigs |>
	left_join(select(ss,assembly_id,run_id)) |>
	left_join(db$SPECIES)	|>
	mutate(assembly_id = fct_reorder(assembly_id,contig_length,sum)) |>
	mutate(contig_id = fct_reorder(contig_id,contig_length,sum)) |>
	ggplot() + 
		facet_grid(run_id~.,space = "free_y",scales="free_y") +
		geom_col(aes(x=contig_length,y=assembly_id,group=contig_id,fill=tag_topology),color="black",position="stack") + 
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
		theme_bw() + theme(legend.position="top")
```

### Color by genus
```{r fig.height=15, fig.width=7}
db$contigs |>
	left_join(select(ss,assembly_id,run_id)) |>
	left_join(db$SPECIES)	|>
	mutate(assembly_id = fct_reorder(assembly_id,contig_length,sum)) |>
	mutate(contig_id = fct_reorder(contig_id,contig_length,sum)) |>
	ggplot() + 
		facet_grid(run_id~.,space = "free_y",scales="free_y") +
		geom_col(aes(x=contig_length,y=assembly_id,group=contig_id,fill=genus_name),color="black",position="stack") + 
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
		theme_bw() + theme(legend.position="top")
```


### Color by plasmid
```{r fig.height=15, fig.width=7}
db$contigs |>
	left_join(select(ss,assembly_id,run_id)) |>
	left_join(db$SPECIES)	|>
	left_join(select(as.data.frame(db$plasmidfinder),contig_id=seqnames,plasmid_type)) |>
	mutate(assembly_id = fct_reorder(assembly_id,contig_length,sum)) |>
	mutate(contig_id = fct_reorder(contig_id,contig_length,sum)) |>
	ggplot() + 
		facet_grid(run_id~.,space = "free_y",scales="free_y") +
		geom_col(aes(x=contig_length,y=assembly_id,group=contig_id,fill=!is.na(plasmid_type)),color="black",position="stack") + 
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
		theme_bw() + theme(legend.position="top") + labs(fill="plamid")
```









# Plasmidfinder typing results {.tabset}

## Overview
```{r fig.height=9, fig.width=5}
select(as.data.frame(db$plasmidfinder),contig_id=seqnames,plasmid_type) |>
	inner_join(select(db$contigs,contig_id,assembly_id)) |>
	right_join(select(ss,assembly_id)) |>
	group_by(plasmid_type) |>
	summarise(n_assembly = n_distinct(assembly_id)) |>
	ungroup() |>
	mutate(plasmid_type=fct_reorder(plasmid_type,n_assembly,mean)) |>
	ggplot(aes(y=plasmid_type,x=n_assembly)) +
		geom_col(fill="lightblue",color="black") +
		geom_text(aes(label=n_assembly),position = position_stack(vjust=0.5),size=3) +
		scale_x_continuous(position="top") +
		theme_bw() +
		ggtitle("Overall Plasmid Type Profile") + xlab("Number of assembly")
```

## Plasmid size
```{r}
select(as.data.frame(db$plasmidfinder),contig_id=seqnames,plasmid_type) |>
	inner_join(select(db$contigs,contig_id,assembly_id,contig_length,contig_GC=GC,contig_topology=tag_topology)) |>
	ggplot(aes(x=contig_length,y=contig_GC,color=contig_topology)) +
		geom_point() + 
		scale_x_continuous(limits=c(0,500e3),oob=scales::squish) + 
		scale_y_continuous(label=scales::percent) + 
		ggtitle("Size, GC content and topology of plasmids") + xlab("Contig size") + ylab("GC content") + labs(color="topology")
```


## Detail map
```{r fig.height=7, fig.width=10}
select(as.data.frame(db$plasmidfinder),contig_id=seqnames,plasmid_type) |>
	inner_join(select(db$contigs,contig_id,assembly_id)) |>
	distinct(assembly_id,plasmid_type) |>
	ggplot(aes(x=assembly_id,y=plasmid_type)) +
		geom_tile(fill="black") +
		theme_bw() + theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1))
```



## Compatibility
```{r fig.height=7, fig.width=8}
select(as.data.frame(db$plasmidfinder),contig_id=seqnames,plasmid_type) |>
	inner_join(select(db$contigs,contig_id,assembly_id)) %>%
	full_join(.,.,by="assembly_id") |>
	filter(contig_id.x != contig_id.y) |>
	group_by(plasmid_type.x,plasmid_type.y) |>
	summarize(n_assembly=n_distinct(assembly_id)) |>
	arrange(desc(n_assembly)) |>
	ungroup() |>
	mutate(plasmid_type.x = fct_reorder(plasmid_type.x,n_assembly,max,.desc = TRUE)) |>
	mutate(plasmid_type.y = fct_reorder(plasmid_type.y,n_assembly,max,.desc = TRUE)) |>
	ggplot(aes(x=plasmid_type.x,y=plasmid_type.y,fill=n_assembly)) +
		geom_tile() +
		theme_bw() + 
		coord_equal() + theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1))
```


# Resfinder results {.tabset}

```{r}
res_count <- select(as.data.frame(db$res),contig_id=seqnames,resistance_name) |>
	inner_join(select(db$contigs,contig_id,assembly_id)) |>
	group_by(resistance_name) |>
	summarise(n_assembly = n_distinct(assembly_id)) |>
	ungroup() |>
	mutate(resistance_name=fct_reorder(resistance_name,n_assembly,mean)) |>
	arrange(desc(resistance_name))
```

## Overview
```{r fig.height=25, fig.width=7}
ggplot(res_count,aes(y=resistance_name,x=n_assembly)) +
	geom_col(fill="lightblue",color="black") +
	geom_text(aes(label=n_assembly),position = position_stack(vjust=0.5),size=3) +
	theme_bw() +
	ggtitle("Overall Resistance Profile")
```


## Strains without the main resistance
```{r fig.height=25, fig.width=7}
select(as.data.frame(db$res),contig_id=seqnames,resistance_name) |>
	inner_join(select(db$contigs,contig_id,assembly_id)) |>
	group_by(assembly_id) |>
	filter(!any(resistance_name %in% slice_max(res_count,n_assembly,n = 1)$resistance_name)) |>
	group_by(resistance_name) |>
	summarise(n_assembly = n_distinct(assembly_id)) |>
	ungroup() |>
	mutate(resistance_name=fct_reorder(resistance_name,n_assembly,mean)) |>
	ggplot(aes(y=resistance_name,x=n_assembly)) +
		geom_col(fill="lightblue",color="black") +
		geom_text(aes(label=n_assembly),position = position_stack(vjust=0.5),size=3) +
		theme_bw() +
		ggtitle("Strains without the main resistance")
```

## Detail
```{r fig.height=15, fig.width=10}
select(as.data.frame(db$res),contig_id=seqnames,resistance_name) |>
	inner_join(select(db$contigs,contig_id,assembly_id)) |>
	group_by(resistance_name) |>
	ggplot(aes(y=resistance_name,x=assembly_id)) +
	geom_tile() + 
	theme(axis.text.x=element_text(angle=45,hjust=1,vjust=1))
```



# Plasmids and Resistance {.tabset}

## Size 
```{r fig.height=6, fig.width=8}
OXA48_CONTIGS <- 
	select(db$contigs,contig_id,assembly_id,contig_length,contig_GC=GC,contig_topology=tag_topology) |>
	left_join(db$SPECIES,by="assembly_id",relationship="many-to-one")	|>
	left_join(select(as.data.frame(db$plasmidfinder),contig_id=seqnames,plasmid_type),by="contig_id",relationship="many-to-many") |>
	left_join(select(as.data.frame(db$resfinder),contig_id=seqnames,resistance_name),by="contig_id",relationship="many-to-many") |>
	left_join(select(ss,assembly_id,sample_type,Localisation,sample_code),by="assembly_id",relationship="many-to-one") |>
	distinct() |>
	mutate(is_plasmid = !is.na(plasmid_type) & (contig_length<=500000)) |>
	filter(resistance_name %in% "blaOXA-48") |>
	mutate(species_name = species_name[drop=TRUE])

ggplot(OXA48_CONTIGS,aes(x=contig_length,y=org_name,color=contig_topology)) + 
	facet_grid(genus_name~.,scales = "free_y",space = "free_y") +
	geom_jitter() + 
	geom_vline(xintercept=500000) +
	ggtitle("Size of contigs carrying blaOXA-48") + 
	theme(strip.text.y=element_text(angle=0))


OXA48_CONTIGS |>
	summarize(num_assembly=n_distinct(assembly_id),num_plasmid=n_distinct(assembly_id[is_plasmid]))

saveRDS(OXA48_CONTIGS,fs::path(params$outdir,"OXA48_CONTIGS.rds"))
openxlsx::write.xlsx(OXA48_CONTIGS,fs::path(params$outdir,"OXA48_CONTIGS.xlsx"))
```

## All plasmids
```{r fig.height=18, fig.width=9}
# How many resistance are on plasmids
OXA48_CONTIGS |>
	filter(is_plasmid) |>
	ggplot(aes(x=contig_length,y=str_glue("{sample_code}__{contig_id}"))) + 
	facet_grid(plasmid_type~.,space="free_y",scales="free_y") + 
	geom_col(aes(fill=org_name,color=contig_topology)) +
	scale_color_manual(values = c(linear="grey",circular="black")) +
	theme_bw() +
	theme(panel.spacing = unit(1,"mm"),strip.text.y=element_text(angle=0))
```



## Environmental samples
```{r  fig.height=6, fig.width=12}
OXA48_CONTIGS |>
	filter(is_plasmid) |>
	filter(sample_type=="environment") |>
	ggplot(aes(x=contig_length,y=str_glue("{sample_code}__{contig_id}"))) + 
	facet_grid(plasmid_type~.,space="free_y",scales="free_y") + 
	geom_col(aes(fill=org_name,color=contig_topology)) +
	scale_color_manual(values = c(linear="grey",circular="black")) +
	theme_bw() +
	theme(panel.spacing = unit(1,"mm"),strip.text.y=element_text(angle=0)) + 
	ggtitle("Environmental samples")
```


## Patient samples
```{r  fig.height=16, fig.width=12}
OXA48_CONTIGS |>
	filter(is_plasmid) |>
	filter(sample_type=="patient") |>
	ggplot(aes(x=contig_length,y=str_glue("{sample_code}__{contig_id}"))) + 
	facet_grid(plasmid_type~.,space="free_y",scales="free_y") + 
	geom_col(aes(fill=org_name,color=contig_topology)) +
	scale_color_manual(values = c(linear="grey",circular="black")) +
	theme_bw() +
	theme(panel.spacing = unit(1,"mm"),strip.text.y=element_text(angle=0)) + 
	ggtitle("Patient samples")
```


## HUG samples
```{r  fig.height=16, fig.width=10}
OXA48_CONTIGS_HUG <- OXA48_CONTIGS |>
	filter(is_plasmid) |>
	filter(Localisation=="HUG") |>
	group_by(sample_code,contig_id,species_name,contig_length,contig_topology) |>
	summarize(plasmid_type = str_c(sort(plasmid_type),collapse = ",")) |>
	ungroup()

OXA48_CONTIGS_HUG |>
	mutate(ylab = str_glue("{sample_code}__{contig_id}") |> str_replace_all("_pilon","")) |>
	mutate(ylab = fct_reorder(ylab,contig_length,mean)) |>
	mutate(plasmid_type = fct_reorder(plasmid_type,rep_along(plasmid_type,-1),sum)) |>
	ggplot(aes(x=contig_length,y=ylab)) + 
		facet_grid(plasmid_type~.,space="free_y",scales="free_y") + 
		geom_col(aes(fill=species_name),color="black") +
		geom_point(aes(x=contig_length/2),data=~filter(.,contig_topology=="circular")) +
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut=scales::cut_short_scale())) +
		scale_fill_discrete(drop=FALSE) +
		theme_bw() + ylab("plasmid") + xlab("plasmid size") +
		theme(panel.spacing = unit(1,"mm"),strip.text.y=element_text(angle=0)) + 
		ggtitle(str_glue("OXA-48 plasmids from HUG samples (n={nrow(OXA48_CONTIGS_HUG)})"))
ggsave("out/hug_plasmids.pdf")
```


## ICH samples
```{r  fig.height=5.5, fig.width=8}
OXA48_CONTIGS_ICH <- OXA48_CONTIGS |>
	filter(is_plasmid) |>
	filter(Localisation=="ICH") |>
	group_by(sample_code,contig_id,species_name,contig_length,contig_topology) |>
	summarize(plasmid_type = str_c(sort(plasmid_type),collapse = ",")) |>
	ungroup() 

OXA48_CONTIGS_ICH |>
	mutate(ylab = str_glue("{sample_code}__{contig_id}") |> str_replace_all("_pilon","")) |>
	mutate(ylab = fct_reorder(ylab,contig_length,mean)) |>
	mutate(plasmid_type = fct_reorder(plasmid_type,rep_along(plasmid_type,-1),sum)) |>
	ggplot(aes(x=contig_length,y=ylab)) + 
		facet_grid(plasmid_type~.,space="free_y",scales="free_y") + 
		geom_col(aes(fill=species_name),color="black") +
		geom_point(aes(x=contig_length/2),data=~filter(.,contig_topology=="circular")) +
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut=scales::cut_short_scale())) +
		scale_fill_discrete(drop=FALSE) +
		theme_bw() + ylab("plasmid") + xlab("plasmid size") +
		theme(panel.spacing = unit(1,"mm"),strip.text.y=element_text(angle=0)) + 
		ggtitle(str_glue("OXA-48 plasmids from ICH samples (n={nrow(OXA48_CONTIGS_ICH)})"))
ggsave("out/ich_plasmids.pdf")
```


## HUG patient samples
```{r  fig.height=14, fig.width=8}
OXA48_CONTIGS_OF_HUG_PATIENTS <- OXA48_CONTIGS |>
	filter(is_plasmid) |>
	filter(Localisation=="HUG") |>
	ungroup() |>
	mutate(species_name = species_name[drop=TRUE]) |>
	filter(sample_type == "patient") |>
	group_by(sample_code,contig_id,species_name,contig_length,contig_topology) |>
	summarize(plasmid_type = str_c(sort(plasmid_type),collapse = ",")) |>
	ungroup() 
	
OXA48_CONTIGS_OF_HUG_PATIENTS |>
	mutate(ylab = str_glue("{sample_code}__{contig_id}") |> str_replace_all("_pilon","")) |>
	mutate(ylab = fct_reorder(ylab,contig_length,mean)) |>
	ggplot(aes(x=contig_length,y=ylab)) + 
		facet_grid(plasmid_type~.,space="free_y",scales="free_y") + 
		geom_col(aes(fill=species_name),color="black") +
		geom_point(aes(x=contig_length/2),data=~filter(.,contig_topology=="circular")) +
		scale_color_manual(values = c(linear="grey",circular="black")) +
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut=scales::cut_short_scale())) +
		scale_fill_discrete(drop=FALSE) +
		theme_bw() + ylab("plasmid") + xlab("plasmid size") +
		theme(panel.spacing = unit(1,"mm"),strip.text.y=element_text(angle=0)) + 
		ggtitle(str_glue("OXA-48 plasmids from HUG patients (n={nrow(OXA48_CONTIGS_OF_HUG_PATIENTS)})"))
ggsave("out/hug_patient_plasmids.pdf")
```


## HUG environment samples
```{r  fig.height=4.5, fig.width=6}
OXA48_CONTIGS_OF_HUG_ENV <- OXA48_CONTIGS |>
	filter(is_plasmid) |>
	filter(Localisation=="HUG") |>
	ungroup() |>
	mutate(species_name = species_name[drop=TRUE]) |>
	filter(sample_type == "environment") |>
	group_by(sample_code,contig_id,species_name,contig_length,contig_topology) |>
	summarize(plasmid_type = str_c(sort(plasmid_type),collapse = ",")) |>
	ungroup() 
	
OXA48_CONTIGS_OF_HUG_ENV |>
	mutate(ylab = str_glue("{sample_code}__{contig_id}") |> str_replace_all("_pilon","")) |>
	mutate(ylab = fct_reorder(ylab,contig_length,mean)) |>
	ggplot(aes(x=contig_length,y=ylab)) + 
		facet_grid(plasmid_type~.,space="free_y",scales="free_y") + 
		geom_col(aes(fill=species_name),color="black") +
		geom_point(aes(x=contig_length/2),data=~filter(.,contig_topology=="circular")) +
		scale_color_manual(values = c(linear="grey",circular="black")) +
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut=scales::cut_short_scale())) +
		scale_fill_discrete(drop=FALSE) +
		theme_bw() + ylab("plasmid") + xlab("plasmid size") +
		theme(panel.spacing = unit(1,"mm"),strip.text.y=element_text(angle=0)) + 
		ggtitle(str_glue("OXA-48 plasmids from environment (n={nrow(OXA48_CONTIGS_OF_HUG_ENV)})"))
ggsave("out/hug_env_plasmids.pdf")
```


## Sion samples
```{r  fig.height=5, fig.width=12}
OXA48_CONTIGS |>
	filter(is_plasmid) |>
	filter(Localisation=="ICH") |>
	ggplot(aes(x=contig_length,y=contig_id)) + 
	facet_grid(plasmid_type~.,space="free_y",scales="free_y") + 
	geom_col(aes(fill=org_name,color=contig_topology)) +
	scale_color_manual(values = c(linear="grey",circular="black")) +
	theme_bw() +
	theme(panel.spacing = unit(1,"mm"),strip.text.y=element_text(angle=0)) + 
	ggtitle("Sion samples")
```



## E.coli 
```{r fig.height=3.7, fig.width=4}
OXA48_CONTIGS |>
	filter(species_name=="Escherichia coli",plasmid_type %in% c("IncM1","IncL")) |>
	mutate(ylab = str_glue("{sample_code}__{contig_id}") |> str_replace_all("_pilon","")) |>
	mutate(ylab = fct_reorder(ylab,contig_length,mean)) |>
	mutate(fct_reorder(ylab,contig_length,mean)) |>
	ggplot(aes(x=contig_length,y=ylab,xend=0,yend=ylab,color=Localisation)) + 
	facet_grid(plasmid_type~.,scales="free_y",space="free_y") +
		geom_segment(size=1) + 
		geom_point() + 
		scale_color_manual(values=c(HUG="orange",ICH="blue")) +
		ylab("plasmid") + xlab("plasmid size") + labs(color="Origin") +
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
		theme_bw()
ggsave("out/ecoli_companion.pdf")
```



## Kpn
```{r fig.height=8, fig.width=5}
OXA48_CONTIGS |>
	filter(species_name=="Klebsiella pneumoniae",plasmid_type %in% c("IncM1","IncL")) |>
	mutate(ylab = str_glue("{sample_code}__{contig_id}") |> str_replace_all("_pilon","")) |>
	mutate(ylab = fct_reorder(ylab,contig_length,mean)) |>
	mutate(fct_reorder(ylab,contig_length,mean)) |>
	ggplot(aes(x=contig_length,y=ylab,xend=0,yend=ylab,color=Localisation)) + 
	facet_grid(plasmid_type~.,scales="free_y",space="free_y") +
		geom_segment(size=1) + 
		geom_point() + 
		scale_color_manual(values=c(HUG="orange",ICH="blue")) +
		ylab("plasmid") + xlab("plasmid size") + labs(color="Origin") +
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
		theme_bw()
ggsave("out/kpn_companion.pdf")
```


## Cfre
```{r fig.height=3, fig.width=5}
OXA48_CONTIGS |>
	filter(species_name=="Citrobacter freundii",plasmid_type %in% c("IncM1","IncL")) |>
	mutate(ylab = str_glue("{sample_code}__{contig_id}") |> str_replace_all("_pilon","")) |>
	mutate(ylab = fct_reorder(ylab,contig_length,mean)) |>
	mutate(fct_reorder(ylab,contig_length,mean)) |>
	ggplot(aes(x=contig_length,y=ylab,xend=0,yend=ylab,color=Localisation)) + 
	facet_grid(plasmid_type~.,scales="free_y",space="free_y") +
		geom_segment(size=1) + 
		geom_point() + 
		scale_color_manual(values=c(HUG="orange",ICH="blue")) +
		ylab("plasmid") + xlab("plasmid size") + labs(color="Origin") +
		scale_x_continuous(position="top",labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
		theme_bw()
ggsave("out/cfre_companion.pdf")
```

# MLST
```{r fig.height=10, fig.width=10}
D <- ss |>
	left_join(db$SPECIES,by="assembly_id") |>
	left_join(db$mlst,by="assembly_id") |>
	left_join(
		OXA48_CONTIGS |> 
			mutate(contig_type = case_when(
				is_plasmid ~ plasmid_type,
				TRUE ~ "chromosomic"
			)) |>
			mutate(contig_type = case_when(
				contig_type %in% c("IncM1","IncL","chromosomic") ~ contig_type,
				TRUE ~ "other Inc"
			)) |>
			distinct(assembly_id,contig_type) |>
			group_by(assembly_id) |> 
			filter(!(any(contig_type %in% c("IncL","IncM1")) & !(contig_type %in% c("IncL","IncM1")))) |>
			filter(!(any(contig_type %in% c("other Inc")) & (contig_type %in% c("chromosomic")))) |>
			summarize(contig_type = str_c(sort(contig_type),collapse=","))
	) |>
	left_join(openxlsx::read.xlsx("local/species_envs.xlsx") |> select(assembly_acc,complex) |> filter(!is.na(complex))) |>
	distinct(assembly_id,mlst_type,species_name,Localisation,contig_type,complex,genus_name) |>
	group_by(mlst_type,species_name,Localisation,contig_type,complex,genus_name) |>
	summarize(n=n_distinct(assembly_id)) |>
	ungroup() |>
	mutate(genus_name = fct_relevel(genus_name,"Klebsiella","Citrobacter","Escherichia","Enterobacter")) |>
	mutate(species_name = fct_relevel(species_name,"Klebsiella pneumoniae","Citrobacter freundii","Enterobacter hormaechei")) |>
	mutate(mlst_type = fct_reorder(mlst_type,n,sum))
	
D |>
	ggplot(aes(y=mlst_type,x=n,fill=contig_type)) +
		facet_grid(genus_name + complex + species_name ~ Localisation,scales = "free_y",space="free_y") +
		scale_x_continuous(position="top") + xlab("Number of isolate") + ylab("ST type") + 
		geom_vline(xintercept=0) +
		geom_col(color="black") + 
		theme_bw() +
		theme(panel.grid = element_blank(),axis.line.y = element_line(),panel.spacing = unit(0,"mm")) +
		theme(strip.background = element_rect(fill = NA)) +
		theme(panel.border = element_blank()) +
		theme(strip.text.y = element_text(angle=0)) 
ggsave("out/oxa_st.pdf")
```




```{r fig.height=1.5, fig.width=6}
D |>
	group_by(Localisation,contig_type) |>
	summarise(n=sum(n)) |>
	mutate(OxaLoc=case_when(contig_type=="chromosomic"~"chromosomic",TRUE~"plasmid")) |>
	ggplot(aes(y=OxaLoc,x=n,fill=contig_type)) + 
		facet_wrap(~Localisation,scales="free_x") +
		geom_col(color="black") +
		geom_text(aes(label=n),size=3,position = position_stack(vjust=0.5)) +
		theme_bw() + ylab("") + xlab("Number of isolate") + labs(fill="Plasmid type") +
		theme(legend.position = "right")
ggsave("out/oxa-loc.pdf")
```

